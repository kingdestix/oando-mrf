<!-- frontend/import.html -->
<!-- FIXED: Automatic import without mapping UI -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Excel - Oando MRF</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .drop-zone {
            border: 3px dashed #d4d4d4;
            border-radius: 0.5rem;
            padding: 3rem 2rem;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #F58220;
            background: #fef3c7;
        }
        
        .drop-zone-icon {
            font-size: 4rem;
            color: #a3a3a3;
            margin-bottom: 1rem;
        }
        
        .drop-zone.dragover .drop-zone-icon {
            color: #F58220;
        }
        
        .file-info {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-top: 1rem;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 2rem;
            background: #e5e5e5;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-top: 1rem;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #F58220 0%, #FCA94B 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/admin-dashboard.html" class="navbar-brand">
                <img src="data:image/svg+xml,%3Csvg width='180' height='80' viewBox='0 0 180 80' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='30' cy='40' r='25' fill='%23FDDB6F'/%3E%3Ccircle cx='30' cy='40' r='20' fill='%23FCA94B'/%3E%3Ccircle cx='30' cy='40' r='15' fill='%23F58220'/%3E%3Ccircle cx='30' cy='40' r='10' fill='%23EA532F'/%3E%3Ccircle cx='30' cy='40' r='6' fill='%2300205B'/%3E%3Ctext x='68' y='52' font-family='Arial, sans-serif' font-size='32' font-weight='bold' fill='%2300205B'%3EOando%3C/text%3E%3C/svg%3E" alt="Oando" class="logo">
            </a>
            <div class="navbar-menu"></div>
            <div class="navbar-user"></div>
            <button class="menu-toggle">‚ò∞</button>
        </div>
    </nav>

    <main class="page-content container">
        <div class="page-header">
            <h1>Import Excel Data</h1>
            <div class="page-header-actions">
                <a href="/admin-dashboard.html" class="btn btn-outline">‚Üê Back to Dashboard</a>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="card mb-3">
            <div class="card-body">
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-icon">üìÅ</div>
                    <h3 style="margin-bottom: 0.5rem;">Drop Excel File Here</h3>
                    <p style="color: #737373; margin-bottom: 1rem;">or click to browse</p>
                    <button type="button" class="btn btn-primary">Select Excel File</button>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                    <p style="color: #a3a3a3; font-size: 0.875rem; margin-top: 1rem;">Supported: .xlsx, .xls</p>
                </div>

                <div class="file-info" id="fileInfo">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong id="fileName"></strong>
                            <div style="color: #737373; font-size: 0.875rem;" id="fileSize"></div>
                        </div>
                        <button onclick="clearFile()" class="btn btn-sm btn-outline">Remove</button>
                    </div>
                </div>

                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>

                <div style="margin-top: 1.5rem; padding: 1rem; background: #e0f2fe; border-radius: 0.375rem; border-left: 4px solid #3b82f6;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #1e40af;">‚ÑπÔ∏è How It Works</h4>
                    <ul style="margin: 0; padding-left: 1.5rem; color: #1e3a8a;">
                        <li>Drop your Excel file (the manager's existing sheet format)</li>
                        <li>System automatically detects columns (Asset, MRF Number, etc.)</li>
                        <li>Data is imported immediately - no mapping needed!</li>
                        <li>Duplicate MRF numbers are skipped automatically</li>
                        <li>You'll see a summary when import completes</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Import Results -->
        <div class="card hidden" id="resultsCard">
            <div class="card-header">
                <h3>Import Results</h3>
            </div>
            <div class="card-body">
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card" style="background: #d1fae5; border-left: 4px solid #10b981;">
                        <div class="stat-label">Successfully Imported</div>
                        <div class="stat-value" id="successCount" style="color: #065f46;">0</div>
                    </div>
                    <div class="stat-card" style="background: #fee2e2; border-left: 4px solid #ef4444;">
                        <div class="stat-label">Failed</div>
                        <div class="stat-value" id="failCount" style="color: #991b1b;">0</div>
                    </div>
                    <div class="stat-card" style="background: #e0e7ff; border-left: 4px solid #6366f1;">
                        <div class="stat-label">Total Rows</div>
                        <div class="stat-value" id="totalCount" style="color: #3730a3;">0</div>
                    </div>
                </div>

                <div id="errorsList" class="hidden" style="margin-top: 1.5rem;">
                    <h4 style="color: #991b1b; margin-bottom: 0.75rem;">‚ö†Ô∏è Errors Found:</h4>
                    <div id="errorsContainer" style="max-height: 300px; overflow-y: auto; background: #fef2f2; padding: 1rem; border-radius: 0.375rem;"></div>
                </div>

                <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem;">
                    <a href="/admin-dashboard.html" class="btn btn-primary">View Dashboard</a>
                    <button onclick="clearFile(); document.getElementById('resultsCard').classList.add('hidden');" class="btn btn-outline">Import Another File</button>
                </div>
            </div>
        </div>
    </main>

    <script src="assets/js/app.js"></script>
    <script>
        let selectedFile = null;

        document.addEventListener('DOMContentLoaded', () => {
            if (!app.requireAuth() || !app.requireRole('admin')) return;
            
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            
            // Click to browse
            dropZone.addEventListener('click', () => fileInput.click());
            
            // File selected
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
            
            // Drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        handleFile(file);
                    } else {
                        app.showAlert('Please upload an Excel file (.xlsx or .xls)', 'error');
                    }
                }
            });
        });

        function handleFile(file) {
            selectedFile = file;
            
            // Show file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').style.display = 'block';
            
            // Auto-start import
            setTimeout(() => {
                startImport();
            }, 500);
        }

        function clearFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
        }

        async function startImport() {
            if (!selectedFile) {
                app.showAlert('Please select a file first', 'error');
                return;
            }

            // Show progress bar
            document.getElementById('progressBar').style.display = 'block';
            updateProgress(10, 'Reading file...');

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('duplicateStrategy', 'skip'); // Auto-skip duplicates

                updateProgress(30, 'Uploading...');

                // ‚úÖ FIXED: Use app.api.upload() which handles auth correctly
                const result = await app.api.upload('/imports/process', formData, (progress) => {
                    updateProgress(30 + (progress * 0.6), 'Processing...');
                });

                updateProgress(100, 'Complete!');
                
                // Show results
                setTimeout(() => {
                    showResults(result.summary);
                }, 500);

            } catch (error) {
                console.error('Import error:', error);
                app.showAlert('Import failed: ' + error.message, 'error');
                document.getElementById('progressBar').style.display = 'none';
            }
        }

        function updateProgress(percent, text) {
            const fill = document.getElementById('progressFill');
            fill.style.width = percent + '%';
            fill.textContent = text || percent + '%';
        }

        function showResults(summary) {
            document.getElementById('successCount').textContent = summary.successful;
            document.getElementById('failCount').textContent = summary.failed;
            document.getElementById('totalCount').textContent = summary.totalRows;
            
            if (summary.errors && summary.errors.length > 0) {
                const container = document.getElementById('errorsContainer');
                container.innerHTML = summary.errors.map(err => `
                    <div style="padding: 0.5rem; border-bottom: 1px solid #fecaca;">
                        <strong style="color: #991b1b;">MRF: ${err.mrf_number || 'Unknown'}</strong>
                        <div style="color: #7f1d1d; font-size: 0.875rem;">${err.error}</div>
                    </div>
                `).join('');
                document.getElementById('errorsList').classList.remove('hidden');
            }
            
            document.getElementById('resultsCard').classList.remove('hidden');
            document.getElementById('progressBar').style.display = 'none';
            
            if (summary.successful > 0) {
                app.showAlert(`‚úÖ Successfully imported ${summary.successful} requests!`, 'success');
            } else {
                app.showAlert('‚ö†Ô∏è No requests were imported. Check errors below.', 'warning');
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
    </script>
</body>
</html>